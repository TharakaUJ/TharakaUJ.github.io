---
permalink: /testing/
title: "Testing"
author_profile: false
sidebar: false
---
<!DOCTYPE html>
<html>

<head>
    <!-- <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script> -->
    <!-- <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe-master.min.js"></script>
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>

    <script>
        AFRAME.registerComponent('adjust-on-lost', {
            schema: {
                motionSensitivity: { type: 'number', default: 0.01 }, // Sensitivity for motion
                rotationSensitivity: { type: 'number', default: 0.01 }, // Sensitivity for rotation
                markerRealWidth: { type: 'number', default: 0.1 }, // Real-world marker width in meters
                noiseThreshold: { type: 'number', default: 0.001 }, // Threshold to filter small movements
            },
            init: function () {
                console.log("Component initialized");
                const marker = document.querySelector('#marker');
                const model = document.querySelector('#model');

                if (!marker || !model) {
                    console.error('Marker or model not found.');
                    return;
                }

                this.lastKnownPosition = new THREE.Vector3();
                this.lastKnownRotation = new THREE.Quaternion();
                this.lastVelocity = new THREE.Vector3();
                this.deviceRotation = new THREE.Quaternion();
                this.modelDetached = false;

                this.markerWidthRatio = 1; // Default ratio, updated on marker detection

                marker.addEventListener('markerFound', () => {
                    console.log('Marker found');
                    this.lastKnownPosition.copy(marker.object3D.position);
                    this.lastKnownRotation.copy(marker.object3D.quaternion);

                    // Calculate the ratio between real-world marker size and AR marker size
                    const markerScale = marker.object3D.scale.x; // Assuming uniform scale
                    this.markerWidthRatio = this.data.markerRealWidth / markerScale;

                    this.modelDetached = false;
                    model.setAttribute('visible', 'true'); // Make model visible
                });

                marker.addEventListener('markerLost', () => {
                    console.log('Marker lost');
                    this.modelDetached = true;
                    model.setAttribute('visible', 'true'); // Keep the model visible for adjustments
                });

                window.addEventListener('deviceorientation', (event) => {
                    if (!this.modelDetached) return;

                    const { alpha, beta, gamma } = event;
                    const quaternion = new THREE.Quaternion();
                    quaternion.setFromEuler(new THREE.Euler(
                        THREE.Math.degToRad(beta || 0),
                        THREE.Math.degToRad(alpha || 0),
                        THREE.Math.degToRad(gamma || 0),
                        'YXZ'
                    ));
                    this.deviceRotation.copy(quaternion);
                });

                window.addEventListener('devicemotion', (event) => {
                    if (!this.modelDetached) return;

                    const accel = event.acceleration;
                    console.log(accel);
                    const deltaTime = event.interval;

                    if (accel) {
                        const threshold = this.data.noiseThreshold;
                        this.lastVelocity.x += Math.abs(accel.x) > threshold ? accel.x * deltaTime : 0;
                        this.lastVelocity.y += Math.abs(accel.y) > threshold ? (accel.y - 10) * deltaTime : 0;
                        this.lastVelocity.z += Math.abs(accel.z) > threshold ? accel.z * deltaTime : 0;

                        this.lastKnownPosition.x += this.lastVelocity.x * deltaTime;
                        this.lastKnownPosition.y += this.lastVelocity.y * deltaTime;
                        this.lastKnownPosition.z += this.lastVelocity.z * deltaTime;
                    }
                });
            },

            tick: function () {
                const { motionSensitivity, rotationSensitivity } = this.data;

                if (this.modelDetached) {
                    // Adjust position
                    const adjustedPosition = this.lastKnownPosition.clone();
                    adjustedPosition.x += this.lastVelocity.x * motionSensitivity;
                    adjustedPosition.y += this.lastVelocity.y * motionSensitivity;
                    adjustedPosition.z += this.lastVelocity.z * motionSensitivity;

                    model.object3D.position.copy(adjustedPosition);

                    // Adjust rotation using device orientation
                    const adjustedRotation = new THREE.Quaternion();
                    adjustedRotation.copy(this.lastKnownRotation).multiply(this.deviceRotation);
                    model.object3D.quaternion.copy(adjustedRotation);
                } else {
                    // Update position and rotation when marker is found
                    model.object3D.position.copy(marker.object3D.position);
                    model.object3D.quaternion.copy(marker.object3D.quaternion);
                }

                model.object3D.updateMatrixWorld();
            }
        });
    </script>

    <style>
        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .arjs-loader div {
            text-align: center;
            font-size: 1.25em;
            color: white;
        }
    </style>

</head>

<body>

    <!-- minimal loader shown until image descriptors are loaded -->
    <div class="arjs-loader">
        <div>Loading, please wait...</div>
    </div>

    <a-scene adjust-on-lost embedded arjs="debugUIEnabled: false;" vr-mode-ui="enabled: false">
        <!-- Marker for initialization -->
        <a-marker id="marker" preset="custom" type="pattern" url="/assets/ar/qr-pattern.patt" smooth="true"
            preload="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="2">
        </a-marker>

        <a-entity id="model" gltf-model="/assets/ar/Pathfinder_2k.glb" scale="1 1 1" position="0 0 0" visible="false">
        </a-entity>
        <a-entity camera></a-entity>

        <a-nft type="nft" url="/assets/ar/pinball" smooth="true" smoothCount="15" smoothTolerance="0.005"
            smoothThreshold="10">

            <a-entity gltf-model="/assets/ar/Pathfinder_2k.glb" scale="500 500 500" position="0 0 -100">
            </a-entity>
        </a-nft>


    </a-scene>
</body>


</html>